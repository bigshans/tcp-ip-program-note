# 基于 TCP 的服务端/客户端（1）

## 4.1 理解 TCP 和 UDP

根据数据传输方式的不同，基于网络协议的套接字一般分为 TCP 套接字和 UDP 套接字。

### 4.1.1 TCP/IP 协议栈

TCP/IP 协议共分四层，可以理解为数据收发分成了 4 个层次化的过程。

分为应用层、传输层、网络层(IP 层)、链路层。TCP 和 UDP 位于传输层。

隔层可能通过操作系统给软件实现，也可能通过类似 NIC 的硬件设备实现。

### 4.1.2 TCP/IP 协议的诞生背景

#### 链路层

链路层是屋里链接领域标准化的结果，也是最基本的领域，专门定义 LAN、WAN、MAN 等网络标准。

这里的链路层是对应七层模型里的物理层和数据链路层的合体。

#### 网络层

本层主要是 IP 协议，用来处理数据传输中的路径问题。

IP 协议是面向消息的、不可靠的。

#### TCP/UDP 层

即传输层。

TCP/UDP 层以 IP 层的数据为基础完成实际数据传输。

#### 应用层

选择数据传输路径、数据确认过程都被隐藏到套接字内部，我们可以直接使用套接字而不必在意套接字的细节。

## 4.2 实现基于 TCP 的服务器端/客户端

### TCP 服务器端的默认函数调用顺序

```
socket() 创建套接字
  |
  v
bind() 分配套接字地址
  |
  v
listen() 等待连接请求状态
  |
  v
accept() 允许连接
  |
  v
read()/write() 数据交换
  |
  v
close() 断开连接
```

### 进入等待连接请求状态

```c
#include <sys/socket.h>

/**
 * @param sock 希望进入连接请求状态的套接字文件描述符，传递的描述符套接字参数将成为服务器端套接字。
 * @param backlog 连接请求等待队列的长度。
 * @return 成功时返回 0 ，失败时返回 -1 。
 */
int listen(int sock, int backlog);
```

服务器端处于等待连接请求状态是指，受理连接前一直使请求出于等待状态。

### 受理客户端连接请求

```c
#include <sys/socket.h>

/**
 * @param 服务器套接字文件描述符
 * @param addr 保存发起连接请求的客户端地址信息的变量地址值，调用后填充客户端地址信息
 * @param addrlen 第二个地址的长度
 * @return 成功时返回套接字文件描述符，失败时返回 -1
 */
int accept(int sock, struct sockaddr * addr, socklen_t * addrlen);
```

`accept` 函数受理连接请求等待队列中待处理的客户端连接请求。

### TCP 客户端的默认函数调用顺序
